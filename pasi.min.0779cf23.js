function SpriteSheet(a,b,c){this.image=a,this.nSprites=b,this.spriteWidth=a.width/b,this.spriteHeight=a.height,c&&(this.flippedImage=SpriteSheet.flip(a),this.mirrored=!0)}function SpriteFont(a,b,c){this.charmap=b,this.charHeight=a.height,this.charWidth=a.width/b.length,this.charSheet=document.createElement("canvas");var d=a.height,e=a.width;this.charSheet.width=e,this.charSheet.height=d,this.ctx=this.charSheet.getContext("2d"),this.ctx.drawImage(a,0,0),this.refData=this.ctx.getImageData(0,0,e,d).data,this.recolour(c)}function Platform(a,b,c){this.x=b,this.y=c,this.sheet=a,this.mirrored=Math.random()>.5,this.imageWidth=a.spriteWidth,this.imageHeight=a.spriteHeight,this.updateCollidingBox()}function PlatformGenerator(a,b,c,d){this.width=b,this.xSpaceMin=a.spriteWidth,this.xSpaceRandom=90,this.ySpaceMin=10,this.ySpaceMax=60,this.spacingFactor=.02,this.branchSheet=a,this.platforms=[new Platform(a,c,d)],this.highestPlatform=this.platforms[0]}function ScrollingBackground(a,b,c){this.image=a,this.vWidht=b,this.vHeight=c,this.bgWidth=a.width,this.bgHeight=a.height}function Pasi(a){this.sheet=a.spriteSheet,this.x=a.x,this.y=a.y,this.acceleration=a.acceleration,this.damping=a.damping,this.jumpSpeed=a.jumpSpeed,this.tiltFactor=a.tiltFactor,this.vx=0,this.vy=0,this.highest=0,this.pose=1,this.width=this.sheet.spriteWidth,this.height=this.sheet.spriteHeight,this.poseThres=.5,this.updateCollidingBox(),this.prevCollidingBox=this.collidingBox}function startGame(a,b,c,d,e,f,g){function h(a){window.requestAnimationFrame(h);var b=a-l;b>=i&&(d(k),c(j,k),l=a-b%i)}var i=1e3/b.fps,j=a.getContext("2d"),k=(a.parentNode,g);e.forEach(function(a){window.addEventListener(a.name,function(b){a.fn(b,k)})}),f.forEach(function(b){a.addEventListener(b.name,function(a){b.fn(a,k)})});var l=0;window.requestAnimationFrame(h)}function initialWorld(a,b){var c={keys:{left:!1,right:!1},gamma:0,width:a,height:b,g:1,resources:{pasiSheet:new SpriteSheet(document.getElementById("pasi"),2,!0),numbers:new SpriteFont(document.getElementById("numbers"),"0123456789",{R:255,G:255,B:255}),background:new ScrollingBackground(BackgroundGenerator.generateBackground(a,b,[["#0a4c08","#0f5805"],["#28641d","#2a6b1d"]]),a,b),branchImg:new SpriteSheet(document.getElementById("branch"),1,!0)},cameraRatio:.3,scrollFactor:.5};return restart(c),c}function restart(a){a.pasi=new Pasi({spriteSheet:a.resources.pasiSheet,x:a.width/2,y:0,acceleration:1.5,damping:1,jumpSpeed:13,tiltFactor:.6}),a.pasi.jump(),a.yCamera=0,a.score=0,a.scoreExtra=0,a.platformGenerator=new PlatformGenerator(a.resources.branchImg,a.width,a.width/2,-2)}function setupCanvas(a,b,c){var d=document.body.getBoundingClientRect(),e=window.devicePixelRatio||1,f=d.right-d.left,g=d.bottom-d.top,h=Math.floor(f*e),i=Math.floor(g*e),j=Math.max(Math.floor(i/a),1),k=Math.floor(i/j),l=Math.round(k*b),m=Math.round(k*c),n=Math.min(Math.max(Math.floor(h/j),l),m),o=document.getElementById("mainCanvas"),p=o.getContext("2d"),q=window.getComputedStyle(o).imageRendering;return"auto"!==q&&q?(o.width=n,o.height=k,o.style.width=n*j/e+"px",o.style.height=k*j/e+"px"):(o.width=n*j,o.height=k*j,o.style.width=o.width/e+"px",o.style.height=o.height/e+"px",p.webkitImageSmoothingEnabled=!1,p.msImageSmoothingEnabled=!1,p.mozImageSmoothingEnabled=!1,p.imageSmoothingEnabled=!1,p.scale(j,j)),{width:n,height:k}}function main(){var a=setupCanvas(260,9/16,.75),b={width:a.width,height:a.height,fps:20},c=initialWorld(b.width,b.height);startGame(document.getElementById("mainCanvas"),b,draw,update,[{name:"keydown",fn:keydown},{name:"keyup",fn:keyup},{name:"deviceorientation",fn:orientation},{name:"click",fn:click}],[],c)}function draw(a,b){b.resources.background.draw(a,Math.round(Math.abs(b.scrollFactor*b.yCamera))),a.save(),a.translate(0,b.height-Math.round(b.yCamera)),b.platformGenerator.platforms.forEach(function(b){b.draw(a)}),b.pasi.draw(a),a.restore(),b.resources.numbers.drawText(a,b.width-1,2,b.score.toString(),"r")}function update(a){if(a.keys.right?a.pasi.vx+=a.pasi.acceleration:a.keys.left?a.pasi.vx-=a.pasi.acceleration:a.gamma?a.pasi.vx=a.pasi.tiltFactor*a.gamma:a.pasi.vx<0?(a.pasi.vx+=a.pasi.damping,a.pasi.vx>0&&(a.pasi.vx=0)):a.pasi.vx>0&&(a.pasi.vx-=a.pasi.damping,a.pasi.vx<0&&(a.pasi.vx=0)),a.pasi.vy+=a.g,a.pasi.update(a.g),a.pasi.wrap(a.width),a.yCamera-a.pasi.y>a.cameraRatio*a.height){{a.yCamera}a.yCamera=a.pasi.y+a.cameraRatio*a.height}a.platformGenerator.generatePlatforms(a.yCamera,a.yCamera-a.height);var b=a.pasi.getCollidingPlatform(a.platformGenerator.platforms);null!==b&&(a.pasi.y=b.y,a.pasi.jump()),a.score=Math.max(Math.round(-a.pasi.highest/5)+a.scoreExtra,0)}function keydown(a,b){39===a.keyCode?b.keys.right=!0:37===a.keyCode&&(b.keys.left=!0)}function keyup(a,b){39===a.keyCode?b.keys.right=!1:37===a.keyCode?b.keys.left=!1:-1!==restartKeys.indexOf(a.keyCode)&&restart(b)}function orientation(a,b){b.gamma=a.gamma}function click(a,b){restart(b)}SpriteSheet.flip=function(a){var b=document.createElement("canvas");b.width=a.width,b.height=a.height;var c=b.getContext("2d");return c.translate(a.width,0),c.scale(-1,1),c.drawImage(a,0,0),b},SpriteSheet.prototype.drawSprite=function(a,b,c,d,e){var f=this.image,g=d;e&&(f=this.flippedImage,g=this.nSprites-1-d),a.drawImage(f,g*this.spriteWidth,0,this.spriteWidth,this.spriteHeight,Math.round(b),Math.round(c),this.spriteWidth,this.spriteHeight)},SpriteFont.prototype.recolour=function(a){for(var b=this.charSheet.height,c=this.charSheet.width,d=this.ctx.createImageData(c,b),e=d.data,f=0,g=4*c*b;g>f;f+=4)this.refData[f+3]>0&&(e[f]=a.R,e[f+1]=a.G,e[f+2]=a.B,e[f+3]=this.refData[f+3]);this.ctx.putImageData(d,0,0)},SpriteFont.prototype.drawText=function(a,b,c,d,e){var f,g=d.length;e||(e="l");var h=(e.toLowerCase(),b);"r"===e?h-=g*this.charWidth:"c"===e&&(h-=Math.round(g*this.charWidth/2));for(var i=0;g>i;++i)f=this.charmap.indexOf(d[i]),-1!==f&&a.drawImage(this.charSheet,f*this.charWidth,0,this.charWidth,this.charHeight,h+i*this.charWidth,c,this.charWidth,this.charHeight)},SpriteFont.prototype.drawLines=function(a,b,c,d,e,f){f||(f=1);for(var g=0,h=d.length;h>g;++g)this.drawText(a,b,c,d[g],e),c+=f*this.charHeight},Platform.prototype.draw=function(a){this.sheet.drawSprite(a,this.x,this.y,0,this.mirrored)},Platform.prototype.updateCollidingBox=function(){this.collidingBox={left:this.x+1,right:this.x+37,top:this.y,bottom:this.y+3}},PlatformGenerator.prototype.generatePlatforms=function(a,b){for(var c=this.platforms.filter(function(b){return b.y<=a}),d=this.highestPlatform,e=Math.min(Math.max(this.spacingFactor*Math.abs(a),1),this.ySpaceMax-this.ySpaceMin);d.y>b;){var f;f=d.x<2*this.xSpaceMin?1:d.x>this.width-2*this.xSpaceMin?-1:Math.random()<.5?-1:1;var g=f*(this.xSpaceMin+this.xSpaceRandom*Math.random()),h=this.ySpaceMin+e*Math.random(),i=Math.min(Math.max(d.x+g,0),this.width-this.xSpaceMin);d=new Platform(this.branchSheet,Math.round(i),Math.round(d.y-h)),c.push(d)}this.platforms=c,this.highestPlatform=d};var BackgroundGenerator={};BackgroundGenerator.generateBackground=function(a,b,c){function d(a,b){f.beginPath(),f.moveTo(0,b),a.forEach(function(a){f.lineTo(a.x,b+a.y)}),f.lineTo(g,h),f.lineTo(0,h),f.closePath(),f.fill()}var e=document.createElement("canvas"),f=e.getContext("2d"),g=a,h=3*b;e.width=g,e.height=h;var i=.15*a,j=.1*b,k=.05*b,l=c.length,m=Math.ceil(h/(3*j+k)/l),n=h/m/l;f.fillStyle=c[c.length-1][1],f.fillRect(0,0,g,h);for(var o=j,p=0;h>o+k+j;){for(var q=0,r=o,s=[];g>q;)q+=i*Math.random()+.1*i,r=-j*Math.random()-.1*j,s.push({x:q,y:r}),q+=i*Math.random()+.1*i,r=j*Math.random()+.1*j,s.push({x:q,y:r});f.fillStyle=c[p][0],d(s,o),f.fillStyle=c[p][1],d(s,o+k),++p===c.length&&(p=0),o+=n}return e},ScrollingBackground.prototype.draw=function(a,b){var c=b%this.bgHeight;a.drawImage(this.image,0,0,this.bgWidth,this.bgHeight-c,0,c,this.bgWidth,this.bgHeight-c),c>0&&a.drawImage(this.image,0,this.bgHeight-c,this.bgWidth,c+1,0,0,this.bgWidth,c+1)},Pasi.prototype.draw=function(a){var b=this.vy<0?0:1;this.sheet.drawSprite(a,this.x,this.y-this.height+3,b,-1===this.pose)},Pasi.prototype.update=function(){this.vx<-1*this.poseThres?this.pose=-1:this.vx>this.poseThres&&(this.pose=1),this.x+=this.vx,this.y+=this.vy,this.highest=Math.min(this.y,this.highest),this.updateCollidingBox()},Pasi.prototype.wrap=function(a){var b=this.width/2;this.x+b<0?this.x=a+b:this.x-b>a&&(this.x=-b)},Pasi.prototype.getCollidingPlatform=function(a){for(var b,c,d=this.collidingBox,e=a.length-1;e>=0;--e)if(b=a[e],c=b.collidingBox,d.left<c.right&&d.right>c.left&&this.prevCollidingBox.bottom<=c.top&&d.bottom>=c.top)return b;return null},Pasi.prototype.jump=function(){this.vy=-this.jumpSpeed},Pasi.prototype.updateCollidingBox=function(){var a={left:this.x+4,right:this.x+20,top:this.y-28,bottom:this.y};-1===this.pose&&(a.left=this.x+2,a.right=this.x+18),this.prevCollidingBox=this.collidingBox,this.collidingBox=a},window.addEventListener("load",main);var restartKeys=[13,32];