function SpriteSheet(a,b,c){this.image=a,this.nSprites=b,this.spriteWidth=a.width/b,this.spriteHeight=a.height,c&&(this.image=ImageUtils.flipSheet(a),this.nSprites*=2)}function SpriteFont(a,b,c){this.charmap=b,this.charHeight=a.height,this.charWidth=a.width/b.length,this.charSheet=document.createElement("canvas");var d=a.height,e=a.width;this.charSheet.width=e,this.charSheet.height=d,this.ctx=this.charSheet.getContext("2d"),this.ctx.drawImage(a,0,0),this.refData=this.ctx.getImageData(0,0,e,d).data,this.recolour(c)}function Platform(a,b,c){this.x=b,this.y=c,this.width=25,this.sheet=a,this.spriteIndex=Math.floor(2*Math.random()),this.imageWidth=a.spriteWidth,this.imageHeight=a.spriteHeight}function PlatformGenerator(a,b,c,d){this.width=b,this.xSpaceMin=30,this.xSpaceRandom=30,this.ySpaceMin=15,this.ySpaceRandom=60,this.branchSheet=a,this.platforms=[new Platform(a,c,d)]}function ScrollingBackground(a,b,c){this.image=a,this.vWidht=b,this.vHeight=c,this.bgWidth=a.width,this.bgHeight=a.height}function Pasi(a){this.sheet=a.spriteSheet,this.x=a.x,this.y=a.y,this.acceleration=a.acceleration,this.damping=a.damping,this.jumpSpeed=a.jumpSpeed,this.tiltFactor=a.tiltFactor,this.yPrev=this.y,this.vx=0,this.vy=0,this.highest=0,this.spriteIndex=0,this.pose=1,this.leaping=!1,this.width=this.sheet.spriteWidth,this.baseWidth=13,this.baseDxRight=3,this.baseDxLeft=-7,this.xOffset=-this.width/2-4,this.height=this.sheet.spriteHeight}function startGame(a,b,c,d,e,f,g){function h(){var c=l.offsetWidth,d=l.offsetHeight,e=Math.floor(c/b.width),f=Math.floor(d/b.height),g=Math.max(Math.min(e,f),1),h=b.width*g,i=b.height*g;a.width=h,a.height=i,a.style.width=h+"px",a.style.height=i+"px",k.imageSmoothingEnabled=!1,k.mozImageSmoothingEnabled=!1,k.webkitImageSmoothingEnabled=!1,k.msImageSmoothingEnabled=!1,k.scale(g,g)}function i(a){window.requestAnimationFrame(i);var b=a-n;b>=j&&(d(m),c(k,m),n=a-b%j)}var j=1e3/b.fps,k=a.getContext("2d"),l=a.parentNode;h(),window.addEventListener("resize",h);var m=g;e.forEach(function(a){window.addEventListener(a.name,function(b){a.fn(b,m)})}),f.forEach(function(b){a.addEventListener(b.name,function(a){b.fn(a,m)})});var n=0;window.requestAnimationFrame(i)}function initialWorld(a,b){var c={keys:{left:!1,right:!1},gamma:0,width:a,height:b,g:1,resources:{pasiSheet:new SpriteSheet(document.getElementById("pasi"),2,!0),numbers:new SpriteFont(document.getElementById("numbers"),"0123456789",{R:255,G:255,B:255}),background:new ScrollingBackground(document.getElementById("background"),a,b),branchImg:new SpriteSheet(document.getElementById("branch"),1,!0)},cameraRatio:.3,scrollFactor:.5};return restart(c),c}function restart(a){a.pasi=new Pasi({spriteSheet:a.resources.pasiSheet,x:a.width/2,y:0,acceleration:1.5,damping:1,jumpSpeed:13,tiltFactor:.6}),a.pasi.vy=-a.pasi.jumpSpeed,a.yCamera=0,a.score=0,a.penalty=0,a.platformGenerator=new PlatformGenerator(a.resources.branchImg,a.width,a.width/2,-2)}function calculateGameDimensions(a,b,c){var d=window.innerWidth,e=window.innerHeight,f=Math.max(Math.floor(e/a),1),g=Math.floor(e/f),h=Math.round(g*b),i=Math.round(g*c),j=Math.min(Math.max(Math.floor(d/f),h),i);return{width:j,height:g}}function main(){var a=calculateGameDimensions(260,9/16,.75),b={width:a.width,height:a.height,fps:20},c=initialWorld(b.width,b.height);startGame(document.getElementById("mainCanvas"),b,draw,update,[{name:"keydown",fn:keydown},{name:"keyup",fn:keyup},{name:"deviceorientation",fn:orientation},{name:"click",fn:click}],[],c)}function draw(a,b){b.resources.background.draw(a,Math.abs(b.scrollFactor*b.yCamera)),a.save(),a.translate(0,b.height-b.yCamera),b.platformGenerator.platforms.forEach(function(b){b.draw(a)}),b.pasi.draw(a),a.restore(),b.resources.numbers.drawText(a,b.width-1,2,b.score.toString(),"r")}function update(a){if(a.keys.right?a.pasi.vx+=a.pasi.acceleration:a.keys.left?a.pasi.vx-=a.pasi.acceleration:a.gamma?a.pasi.vx=a.pasi.tiltFactor*a.gamma:a.pasi.vx<0?(a.pasi.vx+=a.pasi.damping,a.pasi.vx>0&&(a.pasi.vx=0)):a.pasi.vx>0&&(a.pasi.vx-=a.pasi.damping,a.pasi.vx<0&&(a.pasi.vx=0)),a.pasi.vy+=a.g,a.pasi.update(a.g),a.pasi.wrap(a.width),a.yCamera-a.pasi.y>a.cameraRatio*a.height){{a.yCamera}a.yCamera=a.pasi.y+a.cameraRatio*a.height}a.platformGenerator.generatePlatforms(a.yCamera,a.yCamera-a.height);var b=a.pasi.getCollidingPlatform(a.platformGenerator.platforms);null!==b&&(a.pasi.y=b.y,a.pasi.leap(),a.penalty+=5),a.score=Math.max(Math.round(-a.pasi.highest/5)-a.penalty,0)}function keydown(a,b){39===a.keyCode?b.keys.right=!0:37===a.keyCode&&(b.keys.left=!0)}function keyup(a,b){39===a.keyCode?b.keys.right=!1:37===a.keyCode?b.keys.left=!1:-1!==restartKeys.indexOf(a.keyCode)&&restart(b)}function orientation(a,b){b.gamma=a.gamma}function click(a,b){restart(b)}var ImageUtils={};ImageUtils.tmpCanvas=document.createElement("canvas"),ImageUtils.tmpCtx=ImageUtils.tmpCanvas.getContext("2d"),ImageUtils.toImageData=function(a){return ImageUtils.tmpCanvas.width=a.width,ImageUtils.tmpCanvas.height=a.height,ImageUtils.tmpCtx.drawImage(a,0,0),ImageUtils.tmpCtx.getImageData(0,0,a.width,a.height)},ImageUtils.mirror=function(a){var b=document.createElement("canvas");b.width=a.width,b.height=a.height;var c=b.getContext("2d");return c.translate(a.width,0),c.scale(-1,1),c.drawImage(a,0,0),b},ImageUtils.flipSheet=function(a){var b=ImageUtils.mirror(a),c=document.createElement("canvas");c.width=2*a.width,c.height=a.height;var d=c.getContext("2d");return d.drawImage(a,0,0),d.drawImage(b,a.width,0),c},SpriteSheet.prototype.drawSprite=function(a,b,c,d){a.drawImage(this.image,d*this.spriteWidth,0,this.spriteWidth,this.spriteHeight,b,c,this.spriteWidth,this.spriteHeight)},SpriteFont.prototype.recolour=function(a){for(var b=this.charSheet.height,c=this.charSheet.width,d=this.ctx.createImageData(c,b),e=d.data,f=0,g=4*c*b;g>f;f+=4)this.refData[f+3]>0&&(e[f]=a.R,e[f+1]=a.G,e[f+2]=a.B,e[f+3]=this.refData[f+3]);this.ctx.putImageData(d,0,0)},SpriteFont.prototype.drawText=function(a,b,c,d,e){var f,g=d.length;e||(e="l");var h=(e.toLowerCase(),b);"r"===e?h-=g*this.charWidth:"c"===e&&(h-=Math.round(g*this.charWidth/2));for(var i=0;g>i;++i)f=this.charmap.indexOf(d[i]),-1!==f&&a.drawImage(this.charSheet,f*this.charWidth,0,this.charWidth,this.charHeight,h+i*this.charWidth,c,this.charWidth,this.charHeight)},SpriteFont.prototype.drawLines=function(a,b,c,d,e,f){f||(f=1);for(var g=0,h=d.length;h>g;++g)this.drawText(a,b,c,d[g],e),c+=f*this.charHeight},Platform.prototype.draw=function(a){this.sheet.drawSprite(a,this.x-this.imageWidth/2,this.y,this.spriteIndex)},PlatformGenerator.prototype.generatePlatforms=function(a,b){for(var c=this.platforms[this.platforms.length-1],d=this.platforms.filter(function(b){return b.y<=a});c.y>b;){var e=Math.random()<.5?-1:1,f=e*(this.xSpaceMin+this.xSpaceRandom*Math.random()),g=this.ySpaceMin+this.ySpaceRandom*Math.random(),h=Math.min(Math.max(c.x+f,c.width/2),this.width-c.width/2);c=new Platform(this.branchSheet,Math.round(h),Math.round(c.y-g)),d.push(c)}this.platforms=d},ScrollingBackground.prototype.draw=function(a,b){var c=b%this.bgHeight;a.drawImage(this.image,0,0,this.bgWidth,this.bgHeight-c,0,c,this.bgWidth,this.bgHeight-c),c>0&&a.drawImage(this.image,0,this.bgHeight-c,this.bgWidth,c+1,0,0,this.bgWidth,c+1)},Pasi.prototype.draw=function(a){this.sheet.drawSprite(a,this.x+this.xOffset,this.y-this.height+3,this.spriteIndex)},Pasi.prototype.update=function(){this.vx<0?this.pose=-1:this.vx>0&&(this.pose=1);var a=this.vy<0;this.spriteIndex=-1===this.pose?a?3:2:a?0:1,this.yPrev=this.y,this.x+=this.vx,this.y+=this.vy,this.highest=Math.min(this.y,this.highest)},Pasi.prototype.wrap=function(a){var b=this.width/2;this.x+b<0?this.x=a+b:this.x-b>a&&(this.x=-b)},Pasi.prototype.getCollidingPlatform=function(a){for(var b,c=1===this.pose?this.x+this.baseDxRight:this.x+this.baseDxLeft,d=0;d<a.length;d++)if(b=a[d],this.yPrev<=b.y&&this.y>=b.y&&this.vy>0&&Math.abs(c-b.x)<(b.width+this.baseWidth)/2)return b;return null},Pasi.prototype.leap=function(){this.vy=-this.jumpSpeed},window.addEventListener("load",main);var restartKeys=[13,32];