function SpriteSheet(a,b){this.image=a,this.nSprites=b,this.spriteWidth=a.width/b,this.spriteHeight=a.height}function Platform(a,b){this.x=a,this.y=b,this.width=20}function PlatformGenerator(a,b,c){this.width=a,this.xSpaceMin=30,this.xSpaceRandom=5,this.ySpaceMin=60,this.ySpaceRandom=10,this.platforms=[new Platform(b,c)]}function Pasi(a){this.sheet=a.spriteSheet,this.x=a.x,this.y=a.y,this.speed=a.speed,this.jumpSpeed=a.jumpSpeed,this.nLeapTicks=a.nLeapTicks,this.gammaFactor=a.gammaFactor,this.yPrev=this.y,this.vx=0,this.vy=0,this.spriteIndex=0,this.pose=1,this.leaping=!1,this.width=this.sheet.spriteWidth,this.baseWidth=13,this.baseDxRight=3,this.baseDxLeft=-7,this.xOffset=-this.width/2-4,this.height=this.sheet.spriteHeight}function startGame(a,b,c,d,e,f,g){function h(){var c=l.offsetWidth,d=l.offsetHeight,e=Math.floor(c/b.width),f=Math.floor(d/b.height),g=Math.max(Math.min(e,f),1),h=b.width*g,i=b.height*g;a.width=h,a.height=i,a.style.width=h+"px",a.style.height=i+"px",k.imageSmoothingEnabled=!1,k.mozImageSmoothingEnabled=!1,k.webkitImageSmoothingEnabled=!1,k.msImageSmoothingEnabled=!1,k.scale(g,g)}function i(a){window.requestAnimationFrame(i);var b=a-n;b>=j&&(d(m),c(k,m),n=a-b%j)}var j=1e3/b.fps,k=a.getContext("2d"),l=a.parentNode;h(),window.addEventListener("resize",h);var m=g;e.forEach(function(a){window.addEventListener(a.name,function(b){a.fn(b,m)})}),f.forEach(function(b){a.addEventListener(b.name,function(a){b.fn(a,m)})});var n=0;window.requestAnimationFrame(i)}function initialWorld(a,b){var c=new SpriteSheet(document.getElementById("pasi"),4);return{keys:{left:!1,right:!1},gamma:0,width:a,height:b,g:1,pasi:new Pasi({spriteSheet:c,x:a/2,y:b,nLeapTicks:3,speed:4,jumpSpeed:13,gammaFactor:.4}),platformGenerator:new PlatformGenerator(a,a/2,b-2)}}function main(){var a={width:200,height:300,fps:20},b=initialWorld(a.width,a.height);b.pasi.vy=-b.pasi.jumpSpeed,startGame(document.getElementById("mainCanvas"),a,draw,update,[{name:"keydown",fn:keydown},{name:"keyup",fn:keyup},{name:"deviceorientation",fn:orientation}],[],b)}function draw(a,b){a.clearRect(0,0,b.width,b.height),b.platformGenerator.platforms.forEach(function(b){b.draw(a)}),b.pasi.draw(a)}function update(a){a.platformGenerator.generatePlatforms(a.height,0),a.pasi.vx=a.keys.right?a.pasi.speed:a.keys.left?-a.pasi.speed:a.pasi.gammaFactor*a.gamma,a.pasi.vy+=a.g,a.pasi.update(a.g),a.pasi.wrap(a.width);var b=a.pasi.getCollidingPlatform(a.platformGenerator.platforms);null!==b&&(a.pasi.y=b.y,a.pasi.leap())}function keydown(a,b){39===a.keyCode?b.keys.right=!0:37===a.keyCode&&(b.keys.left=!0)}function keyup(a,b){39===a.keyCode?b.keys.right=!1:37===a.keyCode&&(b.keys.left=!1)}function orientation(a,b){b.gamma=a.gamma}SpriteSheet.prototype.drawSprite=function(a,b,c,d){a.drawImage(this.image,d*this.spriteWidth,0,this.spriteWidth,this.spriteHeight,b,c,this.spriteWidth,this.spriteHeight)},Platform.prototype.draw=function(a){a.strokeStyle="blue",a.lineWidth=2,a.beginPath(),a.moveTo(this.x-this.width/2,this.y+1),a.lineTo(this.x+this.width/2,this.y+1),a.stroke()},PlatformGenerator.prototype.generatePlatforms=function(a,b){for(var c=this.platforms[this.platforms.length-1],d=this.platforms.filter(function(b){return b.y<=a});c.y>b;){var e=Math.random()<.5?-1:1,f=e*(this.xSpaceMin+this.xSpaceRandom*Math.random()),g=this.ySpaceMin+this.ySpaceRandom*Math.random(),h=Math.min(Math.max(c.x+f,0),this.width);c=new Platform(Math.round(h),Math.round(c.y-g)),d.push(c)}this.platforms=d},Pasi.prototype.draw=function(a){this.sheet.drawSprite(a,this.x+this.xOffset,this.y-this.height,this.spriteIndex)},Pasi.prototype.update=function(){this.vx<0?this.pose=-1:this.vx>0&&(this.pose=1),this.spriteIndex=1===this.pose?0:2,this.leaping&&(++this.spriteIndex,++this.leapCounter===this.nLeapTicks&&(this.leaping=!1)),this.yPrev=this.y,this.x+=this.vx,this.y+=this.vy},Pasi.prototype.wrap=function(a){var b=this.width/2;this.x+b<0?this.x=a+b:this.x-b>a&&(this.x=-b)},Pasi.prototype.getCollidingPlatform=function(a){for(var b,c=1===this.pose?this.x+this.baseDxRight:this.x+this.baseDxLeft,d=0;d<a.length;d++)if(b=a[d],this.yPrev<=b.y&&this.y>=b.y&&this.vy>0&&Math.abs(c-b.x)<(b.width+this.baseWidth)/2)return b;return null},Pasi.prototype.leap=function(){this.leaping||(this.leaping=!0,this.leapCounter=0,this.vy=-this.jumpSpeed)},window.addEventListener("load",main);